# Hydrospanner

By [SmartyStreets, LLC](http://smartystreets.com)


> "Horizontal boosters. Alluvial dampers? Ow! That's not it, bring me the 
> Hydrospanner. I don't know how we're going to get out of this one." [_citation needed_]


## Why use it?

- Facilitate event-sourced messaging-based architecture
- Minimal boilerplate in application code (business logic is the focus)
- Persistence is handled automatically and all operations are batched
- Snapshots handled regulary and automatically (including loading from latest snapshot at startup)
- fast rebuild of read-model from journaled events (**replay**)
- Allow for scheduled messages ("send me this message in X minutes/hours/days")



## What does it do?

The Hydrospanner hosts your application code, which provides important API 'hooks' (described later). The hydrospanner takes care of the following infrastructure-level concerns:

- receiving external messages from a message queue (RabbitMQ is the supported option right now)
- persisting that message to durable storage (MySQL is the supported option right now)
- passing the message to your application where your important, tested business/domain logic lives
- persisting snapshots of your application's internal state as a public read-model (**projections**) and as a system-wide binary snapshot for fast loading during process restarts.
- publishing resulting messages to an outbound message queue.

At the foundation of the Hydrospanner is the LMAX Disruptor, a "High Performance Inter-Thread Messinging Library" [_citation needed_], which allows data to be passed between threads efficiently. Using this pattern allows various processing steps to be batched efficiently around a few intelligiently provisioned ring buffers.


## How is it used? (Application Hooks - the `IHydratable` interface)


There are two interfaces meant to be implemented by the hosted application by one or more types:

1. `IHydratable`
2. `IHydratable<T>` (where `<T>` refers to the concrete message type)


### `IHydratable`:

`string Key { get; }`

This method provides a string-based location for this `IHydratable`. It should be unique and constant for a given instance.

`bool IsComplete { get; }`

Some types that implement `IHydratable` will have an end to their life-cycle, after which they should not handle any additional messages. This field serves to inform the Hydrospanner when this occurs.

`bool IsPublicSnapshot { get; }`

All instances of types which implement `IHydratable` will be persisted to system-wide, private snapshots to facilitate fast reloading of system state at startup. However, some objects provide a snapshot for a public read-model. If that is the case for your `IHydratable`, make sure this returns `true`;

`IEnumerable<object> GatherMessages()`

This method provides messages generated by your application as a result of handling incoming messages (see `IHydratable<T>`). If your application buffers these messages internally, it is the application's responsibility to clear the buffer as a result of this method call.  Messages gathered from this method will be routed back into the application for additional handling, journaled, and then published to the outbound message queue.

`object GetMemento()`

Returns an object that represents the current internal state of the `IHydratable` to be serialized as a snapshot (whether system-wide or public).


### `IHydratable<T>`

`Hydrate(T message, Dictionary<string, string> headers, live bool)`

Where `<T>` represents the type of the message to be handled. Depending on the purpose of your `IHydratable` this method serves to mutate internal state and/or generate messages to be handled by other handlers.


For a complete example see the SampleApplication project herein.




## Application Configuration


The following parameters can be supplied as `<appSettings>`:

- `hydrospanner-node-id`: numeric value not larger than a `short` that uniquely identifies this hydrospanner instance.
- `hydrospanner-broker-address`: URI for the RabbitMQ server (example: `"amqp://guest:guest@localhost:5672"`)
- `hydrospanner-source-queue`: The name of the queue to which inbound messages will arrive.
- `hydrospanner-system-snapshot-location`: Directory in which to store the system-wide snapshots (defaults to 50,000).
- `hydrospanner-system-snapshot-frequency`: Numeric value which determines how many messages will be processed in between system-wide snapshots.
- `hydrospanner-journal-batch-size`: Numeric value which governs the number of messages to be inserted into MySQL as a transactional batch (defaults to 4,096).
- `hydrospanner-journal`: The name of the connection string (found in the `connectionStrings` section of your app.config) to be used to journal messages.
- `hydrospanner-public-snapshots`: The name of the connection string (found in the `connectionStrings` section of your app.config) to be used for storing public snapshots (**projections**).
- `hydrospanner-duplicate-window`: The number of most recent message id's to load in order to filter duplicate message receipt (defaults to 1024 * 128)

Alternatively, you may provide an instance of a class that inherits from `ConventionWireupParameters` to an overload of the  `Wireup.Initialize(â€¦)` method.